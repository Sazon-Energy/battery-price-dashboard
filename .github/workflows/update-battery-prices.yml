name: Update Battery Prices

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-prices:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Update all battery prices
      id: update_prices
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      run: node scripts/update-all-prices.js
      
    - name: Log completion on success
      if: success()
      run: echo "✅ Battery price update completed successfully at $(date)"
      
    # claude suggest slack but I'm not setting it up for now. Will just leave it commented out
    # Slack notification on failure (optional - requires SLACK_WEBHOOK secret)
    # - name: Notify Slack on failure
    #   if: failure() && secrets.SLACK_WEBHOOK
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: failure
    #     channel: '#alerts'
    #     text: '❌ Battery price update failed! Check the GitHub Actions logs for details.'
    #   env:
    #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
    
    # Email notification on failure (using GitHub's built-in notifications)
    - name: Log failure details
      if: failure()
      run: |
        echo "❌ BATTERY PRICE UPDATE FAILED at $(date)"
        echo "============================================"
        echo "This failure indicates one of the following issues:"
        echo "  1. Database connection problems (Supabase)"
        echo "  2. Website structure changes blocking scrapers"
        echo "  3. Network connectivity issues"
        echo "  4. Invalid environment variables/secrets"
        echo ""
        echo "Action required: Check the logs above for specific error details"
        echo "Repository: ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        exit 1